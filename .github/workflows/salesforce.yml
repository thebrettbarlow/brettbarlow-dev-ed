# Workflow to deploy code to Salesforce.
name: Salesforce

# TODO(brettbarlow): Add a job for linting and static analysis
# TODO(brettbarlow): Run apex tests and collect code coverage information

on:
  workflow_dispatch:
  schedule:
    - cron: '30 10 * * *' # 10:30 UTC == 03:30 PT
  push:
    branches:
      - main
    paths:
      - 'force-app/**'

jobs:
  deploy-to-salesforce:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3

      - name: Install SFDX
        run: |
          wget https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz
          mkdir ~/sfdx
          tar xJf sfdx-linux-x64.tar.xz -C ~/sfdx --strip-components 1
          echo "$HOME/sfdx/bin" >> $GITHUB_PATH
          ~/sfdx/bin/sfdx version

      - name: Connect to Salesforce
        run: |
          echo ${{ secrets.SFDX_AUTH_URL }} > sfdxurlfile.txt
          sfdx auth:sfdxurl:store \
            --sfdxurlfile=sfdxurlfile.txt \
            --setalias=devhub

      - name: Create Scratch Org
        run: |
          sfdx force:org:create \
            --definitionfile=config/project-scratch-def.json \
            --setalias=scratch-org \
            --targetdevhubusername=devhub

      - name: Make the Experience Cloud Site
        run: |
          sfdx force:community:create \
            --targetusername=scratch-org \
            --name=Home \
            --urlpathprefix="" \
            --templatename="Build Your Own (LWR)" \
            templateParams.AuthenticationType=UNAUTHENTICATED

      - name: Deploy Base Metadata
        run: |
          sfdx force:source:deploy \
            --targetusername=scratch-org \
            --metadata=AuraDefinitionBundle,ApexClass,Flexipage,Layout,LightningComponentBundle,CustomObject,PermissionSet,StaticResource,CustomTab,SharingRules

      - name: Deploy Experience Cloud Metadata
        run: |
          sfdx force:source:deploy \
            --targetusername=scratch-org \
            --metadata=ExperienceBundle,NavigationMenu,Network,ApexPage,Profile,CustomSite

      - name: Publish the Experience Cloud Site
        run: |
          sfdx force:community:publish \
            --targetusername=scratch-org \
            --name=Home

      - name: Delete Scratch Org
        if: always()
        run: |
          sfdx force:org:delete \
            --targetusername=scratch-org \
            --noprompt

      - name: Deploy to Salesforce
        run: |
          sfdx force:source:deploy \
            --testlevel=RunLocalTests \
            --sourcepath=force-app \
            --targetusername=devhub

      - name: Publish the Experience Cloud Site
        run: |
          sfdx force:community:publish \
            --targetusername=devhub \
            --name=Home
